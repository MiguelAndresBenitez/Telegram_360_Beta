================================================================================
ðŸ“± TELETHON EN PRODUCCIÃ“N - GESTIÃ“N DE SESIONES
================================================================================

Problema: Las .session files no se subieron al servidor
SoluciÃ³n: Hay 3 formas de manejar sesiones Telethon en producciÃ³n

================================================================================
Â¿QUÃ‰ SON LAS .SESSION FILES?
================================================================================

Las .session files contienen:
- Credenciales cifradas de tu cuenta de Telegram
- Token de sesiÃ³n activo
- InformaciÃ³n de la sesiÃ³n para no volver a autenticar

Archivo tÃ­pico: plataforma_session.session (binario cifrado)

âš ï¸ NUNCA subirlas a repositorio pÃºblico - son como contraseÃ±as
âš ï¸ NUNCA compartirlas sin protecciÃ³n
âš ï¸ Almacenarlas en /home/telegramapp/app/ en el servidor

================================================================================
OPCIÃ“N 1: GENERAR SESIÃ“N EN EL SERVIDOR (RECOMENDADO)
================================================================================

Ventajas:
âœ… No necesitas copiar archivos sensibles
âœ… La sesiÃ³n se genera directamente en el servidor
âœ… MÃ¡s seguro

Desventajas:
âŒ Requiere acceso interactivo al servidor
âŒ Si tienes 2FA, necesitas proporcionarlo

Pasos:

1. Conectar al servidor

$ ssh telegramapp@servidor

2. Activar virtual environment

$ source ~/app/venv/bin/activate

3. Crear script de inicializaciÃ³n

$ cat > ~/app/init_session.py << 'EOF'
#!/usr/bin/env python3

import os
import sys
from pathlib import Path
from dotenv import load_dotenv

# Cargar variables de .env.prod
load_dotenv('/home/telegramapp/app/.env.prod')

# Obtener credenciales
api_id = os.getenv('TELEGRAM_API_ID')
api_hash = os.getenv('TELEGRAM_API_HASH')
phone = os.getenv('TELEGRAM_PHONE')  # Tu nÃºmero de telÃ©fono

if not all([api_id, api_hash, phone]):
    print("âŒ ERROR: Faltan credenciales en .env.prod")
    print("Requiere: TELEGRAM_API_ID, TELEGRAM_API_HASH, TELEGRAM_PHONE")
    sys.exit(1)

print(f"ðŸ“± Iniciando sesiÃ³n con telÃ©fono: {phone}")
print(f"ðŸ“ API ID: {api_id}")
print(f"ðŸ”’ Conectando...")

# Importar Telethon DESPUÃ‰S de cargar env
from telethon import TelegramClient
from telethon.errors import SessionPasswordNeededError

# Crear cliente (genera .session file automÃ¡ticamente)
client = TelegramClient(
    'plataforma_session',
    int(api_id),
    api_hash,
    system_version='4.16.30-vxImperia'
)

async def main():
    try:
        # Conectar
        await client.connect()
        
        # Verificar si ya existe sesiÃ³n
        if await client.is_user_authorized():
            me = await client.get_me()
            print(f"âœ… SesiÃ³n existente: {me.first_name}")
            return
        
        print("ðŸ”‘ Primera vez - enviando cÃ³digo de verificaciÃ³n...")
        
        # Solicitar cÃ³digo
        result = await client.send_code_request(phone)
        
        # Esperar entrada del usuario
        code = input("ðŸ“¬ Ingresa el cÃ³digo que recibiste: ")
        
        try:
            # Intentar login con cÃ³digo
            await client.sign_in(phone, code)
            print("âœ… SesiÃ³n creada exitosamente!")
            
        except SessionPasswordNeededError:
            # Si tiene 2FA activado
            password = input("ðŸ” Cuenta con 2FA. Ingresa contraseÃ±a: ")
            await client.sign_in(password=password)
            print("âœ… SesiÃ³n creada con 2FA!")
            
    except Exception as e:
        print(f"âŒ Error: {e}")
        sys.exit(1)
    finally:
        await client.disconnect()

# Ejecutar
import asyncio
asyncio.run(main())
EOF

4. Ejecutar script

$ python ~/app/init_session.py

# Seguir las instrucciones (ingresar cÃ³digo de verificaciÃ³n)

5. Verificar archivo creado

$ ls -la ~/app/plataforma_session.session

# DeberÃ­as ver el archivo (~5-10 KB)

6. Dar permisos restrictivos

$ chmod 600 ~/app/plataforma_session.session

7. Listo - el archivo estÃ¡ en el servidor

$ file ~/app/plataforma_session.session
# Esperado: "data" o "SQLite 3.x"

================================================================================
OPCIÃ“N 2: COPIAR .SESSION FILE DESDE TU MÃQUINA LOCAL
================================================================================

Si ya generaste sesiÃ³n localmente y quieres usarla en producciÃ³n:

Ventajas:
âœ… Ya tienes el archivo localmente
âœ… No necesitas interactuar con el servidor
âœ… RÃ¡pido

Desventajas:
âŒ Requiere copiar archivo sensible
âŒ MÃ¡yor riesgo si la conexiÃ³n no es segura
âŒ La sesiÃ³n local y remota pueden entrar en conflicto

Pasos:

1. EN TU MÃQUINA LOCAL - Buscar archivo de sesiÃ³n

# Linux/Mac
$ find ~ -name "*.session" -type f 2>/dev/null
$ find ~ -name "plataforma_session.session" -type f

# Windows
# Buscar en C:\Users\tu_usuario\ recursivamente

Ejemplo: /Users/miguel/.local/share/telethon/plataforma_session.session
O: /home/miguel/project/plataforma_session.session

2. Copiar al servidor vÃ­a SCP

$ scp /path/local/plataforma_session.session \
    telegramapp@servidor.com:/home/telegramapp/app/

# O si estÃ¡s dentro del servidor:
$ scp plataforma_session.session telegramapp@servidor.com:/home/telegramapp/app/

3. EN EL SERVIDOR - Dar permisos

$ ssh telegramapp@servidor
$ chmod 600 ~/app/plataforma_session.session

4. Verificar

$ ls -la ~/app/plataforma_session.session

âœ… Listo

================================================================================
OPCIÃ“N 3: GENERAR EN DOCKER LOCAL, COPIAR AL SERVIDOR (MÃ¡s seguro)
================================================================================

Si quieres generar una sesiÃ³n NUEVA y segura sin exponer credenciales:

1. EN TU MÃQUINA LOCAL - Usar Docker

$ cat > Dockerfile.session << 'EOF'
FROM python:3.12-slim

RUN pip install telethon python-dotenv

WORKDIR /app
COPY .env.prod .env.prod
COPY init_session.py init_session.py

CMD ["python", "init_session.py"]
EOF

2. Construir imagen

$ docker build -f Dockerfile.session -t telegram-session .

3. Ejecutar (te pedirÃ¡ cÃ³digo interactivo)

$ docker run -it \
    -v $(pwd):/app \
    telegram-session

# Ingresar el cÃ³digo de verificaciÃ³n cuando pida

4. Copiar al servidor

$ scp plataforma_session.session telegramapp@servidor:/home/telegramapp/app/

================================================================================
CONFIGURAR TELETHON EN LA APLICACIÃ“N
================================================================================

El cÃ³digo en telegram-workers/workers/ ya deberÃ­a estar configurado.

Verificar: telegram-workers/workers/authenticate.py

DeberÃ­a incluir:

```python
from telethon import TelegramClient

client = TelegramClient(
    'plataforma_session',  # Archivo de sesiÃ³n
    int(os.getenv('TELEGRAM_API_ID')),
    os.getenv('TELEGRAM_API_HASH'),
)

async def get_authenticated_client():
    """Obtener cliente autenticado"""
    if not await client.is_connected():
        await client.connect()
    
    if not await client.is_user_authorized():
        raise Exception("Cliente no autenticado")
    
    return client
```

Variables requeridas en .env.prod:

TELEGRAM_API_ID=1234567        # De my.telegram.org
TELEGRAM_API_HASH=abcdef123    # De my.telegram.org
TELEGRAM_PHONE=+34666777888    # Tu nÃºmero
TELEGRAM_SESSION_FILE=plataforma_session.session

================================================================================
OBTENER CREDENCIALES DE TELEGRAM (.env.prod)
================================================================================

Necesitas:
1. TELEGRAM_API_ID
2. TELEGRAM_API_HASH

Pasos:

1. Ir a https://my.telegram.org/apps

2. Login con tu nÃºmero de telÃ©fono

3. Rellenar formulario
   Nombre: Plataforma 360 Telegram
   Plataforma: Desktop (o Server)
   DescripciÃ³n: Application for managing telegram channels

4. RecibirÃ¡s:
   api_id = 1234567
   api_hash = abcdef0123456789abcdef012345678

5. Agregar a .env.prod:

TELEGRAM_API_ID=1234567
TELEGRAM_API_HASH=abcdef0123456789abcdef012345678
TELEGRAM_PHONE=+34666777888

================================================================================
PROBAR SESIÃ“N EN PRODUCCIÃ“N
================================================================================

DespuÃ©s de copiar/generar .session file:

1. SSH al servidor

$ ssh telegramapp@servidor

2. Activar venv

$ source ~/app/venv/bin/activate

3. Probar conexiÃ³n

$ python << 'EOF'
import asyncio
from telethon import TelegramClient
import os

async def test():
    client = TelegramClient('plataforma_session', os.getenv('TELEGRAM_API_ID'), os.getenv('TELEGRAM_API_HASH'))
    
    try:
        await client.connect()
        
        if await client.is_user_authorized():
            me = await client.get_me()
            print(f"âœ… SesiÃ³n funcionando: {me.first_name}")
        else:
            print("âŒ No autenticado")
            
    finally:
        await client.disconnect()

asyncio.run(test())
EOF

Esperado: "âœ… SesiÃ³n funcionando: TuNombre"

================================================================================
PROBLEMAS Y SOLUCIONES
================================================================================

âŒ PROBLEMA: "No such file or directory: plataforma_session.session"

SOLUCIÃ“N:
- Verificar que el archivo exista: ls -la ~/app/plataforma_session.session
- Si no existe, ejecutar OPCIÃ“N 1 (generar sesiÃ³n)
- Si existe, verificar ruta en cÃ³digo

---

âŒ PROBLEMA: "Connection refused" al conectar a Telegram

SOLUCIÃ“N:
- La sesiÃ³n probablemente expirÃ³
- Generar sesiÃ³n nueva con OPCIÃ“N 1
- Verificar conexiÃ³n a internet: ping google.com

---

âŒ PROBLEMA: "Unauthorized: could not deserialize"

SOLUCIÃ“N:
- El archivo .session estÃ¡ corrupto
- Eliminar: rm ~/app/plataforma_session.session
- Generar nuevo con OPCIÃ“N 1

---

âŒ PROBLEMA: "Invalid phone number"

SOLUCIÃ“N:
- Verificar formato: +34666777888 (con +)
- En .env.prod: TELEGRAM_PHONE=+34666777888

---

âŒ PROBLEMA: Error 2FA "SessionPasswordNeededError"

SOLUCIÃ“N:
- Tienes autenticaciÃ³n de dos factores activada
- El script pide contraseÃ±a automÃ¡ticamente
- Ingresar contraseÃ±a cuando solicita

================================================================================
MONITOREO DE SESIÃ“N
================================================================================

Ver logs de workers:

$ tail -f /home/telegramapp/app/logs/workers.log

Reiniciar workers (si sesiÃ³n falla):

$ sudo supervisorctl restart telegram:telegram-workers

Verificar estado:

$ sudo supervisorctl status telegram:telegram-workers

Esperado: "RUNNING"

================================================================================
SEGURIDAD: BUENAS PRÃCTICAS
================================================================================

âœ… DO:

1. âœ… Usar archivo .session en /home/telegramapp/app/
2. âœ… Dar permisos 600: chmod 600 plataforma_session.session
3. âœ… Backupear archivo de sesiÃ³n: cp plataforma_session.session plataforma_session.backup
4. âœ… Usar .env.prod para credenciales (nunca hardcodear)
5. âœ… Regenerar sesiÃ³n cada 6 meses
6. âœ… Usar VPN/SSH para copiar sesiones
7. âœ… Verificar que solo telegramapp pueda leer: ls -l plataforma_session.session

âŒ DON'T:

1. âŒ Subirlo a GitHub (nunca)
2. âŒ Compartirlo sin protecciÃ³n
3. âŒ Usar mismo archivo en mÃºltiples servidores simultÃ¡neamente
4. âŒ Hardcodear credenciales en cÃ³digo
5. âŒ Permitir que otros usuarios lean el archivo
6. âŒ Guardarlos en carpeta pÃºblica
7. âŒ Usarlos en desarrollo Y producciÃ³n simultÃ¡neamente

================================================================================
RESUMEN RÃPIDO
================================================================================

Para tu setup:

1. SSH al servidor:
   $ ssh telegramapp@servidor

2. Generar sesiÃ³n (RECOMENDADO):
   $ source ~/app/venv/bin/activate
   $ python ~/app/init_session.py
   (ingresar cÃ³digo de verificaciÃ³n)

3. O copiar desde local:
   $ scp plataforma_session.session telegramapp@servidor:/home/telegramapp/app/

4. Dar permisos:
   $ chmod 600 ~/app/plataforma_session.session

5. Verificar:
   $ python -c "from telethon import TelegramClient; print('âœ… Telethon OK')"

6. Listo - supervisor lo usarÃ¡ automÃ¡ticamente

================================================================================
